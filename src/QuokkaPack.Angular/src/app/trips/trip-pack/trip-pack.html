<div class="trip-pack-container">
  <div class="mode-selector">
    <div class="radio-group">
      <label class="radio-label">
        <input type="radio" name="mode" [checked]="mode()==='pack'" (change)="setMode('pack')" />
        <span>Pack</span>
      </label>
      <label class="radio-label">
        <input type="radio" name="mode" [checked]="mode()==='edit'" (change)="setMode('edit')" />
        <span>Edit</span>
      </label>
    </div>

    <div class="status-messages">
      @if (loading()) { <span class="loading">Loading‚Ä¶</span> }
      @if (error()) { <span class="error">{{ error() }}</span> }
    </div>
  </div>

  @if (trip(); as t) {
    <section class="trip-info-card">

      <!-- Header: readonly vs editable -->
      @if (mode()==='edit' && edit) {
        <div class="trip-edit-form">
          <div class="form-group">
            <label for="destination">Destination</label>
            <input id="destination" type="text" [(ngModel)]="edit.destination" />
          </div>
          <div class="form-group">
            <label for="startDate">Start</label>
            <input id="startDate" type="date" [(ngModel)]="edit.startDate" />
          </div>
          <div class="form-group">
            <label for="endDate">End</label>
            <input id="endDate" type="date" [(ngModel)]="edit.endDate" />
          </div>
          <button type="button" class="btn-primary" (click)="saveTrip()" [disabled]="loading() || !canSave(edit)">Save</button>
        </div>
      } @else {
        <div class="trip-header">
          <h2>{{ t.destination }}</h2>
          <p class="trip-dates">{{ t.startDate }} ‚Äì {{ t.endDate }}</p>
        </div>
      }

      <!-- Body -->
      @if (mode()==='pack') {
        <!-- Only items that are part of the trip, with live API updates on toggle -->
        <div class="pack-mode">
          <h3 class="mode-title">Pack Mode</h3>

          <div class="categories-grid">
            @for (g of packGroups(); track g.categoryName) {
              <div class="category-card">
                <h4 class="category-title">
                  {{ g.categoryName }} <span class="count">({{ g.itemsInTrip.length }})</span>
                </h4>

                <ul class="items-list">
                  @for (it of g.itemsInTrip; track it.tripItemId) {
                    <li class="item-row">
                      <label class="checkbox-label">
                        <input
                          type="checkbox"
                          [checked]="packedMap()[it.tripItemId!]"
                          (change)="onPackedChange(it, $any($event.target).checked)" />
                        <span
                          class="item-name"
                          [class.packed]="packedMap()[it.tripItemId!]">
                          {{ it.name }}
                        </span>
                      </label>
                    </li>
                  }
                </ul>
              </div>
            }
          </div>
        </div>

      } @else {
        <!-- Edit mode: all items grouped by category -->
        <div class="edit-mode">
          <h3 class="mode-title">Edit Mode</h3>

          <div class="categories-grid">
            <!-- Category cards -->
            @for (g of groupsInTrip(); track g.categoryName) {
              <div class="category-card">
                <h4 class="category-title">
                  {{ g.categoryName }} <span class="count">({{ g.itemsInTrip.length + g.itemsNotInTrip.length }})</span>
                </h4>

                <div class="edit-items-grid">
                  @for (it of g.itemsInTrip; track it.tripItemId) {
                    <button
                      type="button"
                      (click)="removeFromTrip(it)"
                      title="Remove from trip"
                      class="btn-icon btn-danger">
                      üóëÔ∏è
                    </button>

                    <input
                      type="checkbox"
                      [checked]="it.isPacked"
                      disabled />

                    <span class="item-name">{{ it.name }}</span>
                  }

                  @for (it of g.itemsNotInTrip; track it.id) {
                    <button
                      type="button"
                      (click)="addToTrip(it)"
                      title="Add to trip"
                      class="btn-icon btn-success">
                      ‚ûï
                    </button>

                    <span class="item-name item-not-in-trip">{{ it.name }}</span>
                  }
                </div>
              </div>
            }

            <!-- Available categories card -->
            <div class="category-card available-categories">
              <h4 class="category-title">Available categories</h4>

              <div class="available-list">
                @for (g of availableGroups(); track g.categoryName) {
                  <div class="available-item">
                    <span class="dot">‚ö´</span>
                    <span>{{ g.categoryName }} ({{ g.itemsNotInTrip.length }})</span>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      }
    </section>
  }
</div>
