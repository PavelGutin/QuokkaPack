<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="btn-group" role="group">
      <input type="radio" class="btn-check" name="mode" id="modepack" [checked]="mode()==='pack'" (change)="setMode('pack')" autocomplete="off">
      <label class="btn btn-outline-primary" for="modepack">Pack</label>

      <input type="radio" class="btn-check" name="mode" id="modeedit" [checked]="mode()==='edit'" (change)="setMode('edit')" autocomplete="off">
      <label class="btn btn-outline-primary" for="modeedit">Edit</label>
    </div>

    <div>
      @if (loading()) { <span class="text-muted fst-italic">Loading‚Ä¶</span> }
      @if (error()) { <span class="text-danger">{{ error() }}</span> }
    </div>
  </div>

  @if (trip(); as t) {
    <div class="card shadow">
      <div class="card-body p-4">
        @if (mode()==='edit' && edit) {
          <div class="mb-4">
            <div class="row g-3">
              <div class="col-12">
                <label for="destination" class="form-label">Destination</label>
                <input id="destination" type="text" class="form-control" [(ngModel)]="edit.destination" />
              </div>
              <div class="col-md-6">
                <label for="startDate" class="form-label">Start</label>
                <input id="startDate" type="date" class="form-control" [(ngModel)]="edit.startDate" />
              </div>
              <div class="col-md-6">
                <label for="endDate" class="form-label">End</label>
                <input id="endDate" type="date" class="form-control" [(ngModel)]="edit.endDate" />
              </div>
            </div>
            <button type="button" class="btn btn-primary mt-3" (click)="saveTrip()" [disabled]="loading() || !canSave(edit)">Save</button>
          </div>
        } @else {
          <div class="mb-4">
            <h2 class="mb-1">{{ t.destination }}</h2>
            <p class="text-muted mb-0">{{ t.startDate }} ‚Äì {{ t.endDate }}</p>
          </div>
        }

        @if (mode()==='pack') {
          <div>
            <div class="row g-3">
              @for (g of packGroups(); track g.categoryName) {
                <div class="col-12 col-md-6 col-lg-4">
                  <div class="card">
                    <div class="card-header">
                      <h4 class="h6 mb-0">
                        {{ g.categoryName }} <span class="badge bg-secondary">{{ g.itemsInTrip.length }}</span>
                      </h4>
                    </div>
                    <div class="card-body">
                      <div class="list-group list-group-flush">
                        @for (it of g.itemsInTrip; track it.tripItemId) {
                          <label class="list-group-item">
                            <input
                              type="checkbox"
                              class="form-check-input me-2"
                              [checked]="packedMap()[it.tripItemId!]"
                              (change)="onPackedChange(it, $any($event.target).checked)" />
                            <span [class.text-decoration-line-through]="packedMap()[it.tripItemId!]" [class.text-muted]="packedMap()[it.tripItemId!]">
                              {{ it.name }}
                            </span>
                          </label>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

        } @else {
          <div>
            <div class="row g-3">
              @for (g of groupsInTrip(); track g.categoryName) {
                <div class="col-12 col-md-6 col-lg-4">
                  <div class="card">
                    <div class="card-header">
                      <h4 class="h6 mb-0">
                        {{ g.categoryName }} <span class="badge bg-secondary">{{ g.itemsInTrip.length + g.itemsNotInTrip.length }}</span>
                      </h4>
                    </div>
                    <div class="card-body">
                      <div class="list-group list-group-flush">
                        @for (it of g.itemsInTrip; track it.tripItemId) {
                          <div class="list-group-item d-flex align-items-center gap-2 px-0">
                            <input
                              type="checkbox"
                              class="form-check-input m-0"
                              [checked]="it.isPacked"
                              disabled />
                            <span class="flex-grow-1">{{ it.name }}</span>
                            <button
                              type="button"
                              (click)="removeFromTrip(it)"
                              title="Remove from trip"
                              class="btn btn-sm border-0"
                              style="opacity: 0.3; transition: opacity 0.2s;"
                              (mouseenter)="$any($event.target).style.opacity = '1'"
                              (mouseleave)="$any($event.target).style.opacity = '0.3'">
                              üóëÔ∏è
                            </button>
                          </div>
                        }

                        @for (it of g.itemsNotInTrip; track it.id) {
                          <div class="list-group-item d-flex align-items-center gap-2 px-0">
                            <span class="flex-grow-1 text-muted">{{ it.name }}</span>
                            <button
                              type="button"
                              (click)="addToTrip(it)"
                              title="Add to trip"
                              class="btn btn-sm border-0"
                              style="opacity: 0.3; transition: opacity 0.2s;"
                              (mouseenter)="$any($event.target).style.opacity = '1'"
                              (mouseleave)="$any($event.target).style.opacity = '0.3'">
                              ‚ûï
                            </button>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              }

              @if (availableGroups().length > 0) {
                <div class="col-12 col-md-6 col-lg-4">
                  <div class="card border-secondary">
                    <div class="card-header bg-light">
                      <h4 class="h6 mb-0">Available categories</h4>
                    </div>
                    <div class="card-body">
                      @for (g of availableGroups(); track g.categoryName) {
                        <div class="mb-2">
                          <span class="badge bg-secondary me-2">‚ö´</span>
                          <span>{{ g.categoryName }} ({{ g.itemsNotInTrip.length }})</span>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
