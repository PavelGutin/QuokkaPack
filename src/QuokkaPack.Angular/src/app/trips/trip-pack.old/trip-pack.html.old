<div class="page">
  @if (loading()) {
    <div class="loading">Loading…</div>
  } @else {
    @if (error()) {
      <p class="error">{{ error() }}</p>
    }

    @if (trip(); as t) {
      <header class="header">
        <div>
          <h2>Pack: {{ t.destination }}</h2>
          <div class="dates">
            <span>{{ t.startDate | date:'mediumDate' }}</span>
            <span>—</span>
            <span>{{ t.endDate   | date:'mediumDate' }}</span>
          </div>
        </div>

        <nav class="header-actions">
          <a [routerLink]="['/trips', t.id, 'edit']" class="link">Edit Trip</a>
        </nav>
      </header>
    }

    <div class="toolbar">
    <input
    type="search"
    placeholder="Filter items…"
    [(ngModel)]="filterText"
    class="filter"
    />
      <button class="save" [disabled]="!anyDirty() || saving()" (click)="save()">
        {{ saving() ? 'Saving…' : 'Update Packed Status' }}
      </button>
    </div>

    <section class="groups">
      @for (group of grouped(); track group[0]) {
        @let cat = group[0];
        @let items = group[1];

        <div class="group">
          <div class="group-header">
            <h3 class="cat">{{ cat }}</h3>
            <div class="cat-actions">
              <button class="tiny" (click)="toggleCategory(cat, true)">Pack all</button>
              <button class="tiny" (click)="toggleCategory(cat, false)">Unpack all</button>
            </div>
          </div>

          <ul class="items">
            @for (it of items; track it.id) {
              <li class="item">
                <label class="row">
                  <input
                    type="checkbox"
                    [checked]="it.isPacked"
                    (change)="togglePacked(it, $any($event.target).checked)"
                  />
                  <span class="name">{{ it.name }}</span>
                  <span class="qty" title="Quantity">×{{ it.quantity }}</span>
                  @if (it.dirty) {
                    <span class="dot" title="Pending change"></span>
                  }
                </label>
              </li>
            }
          </ul>
        </div>
      }
    </section>

    <div class="footer">
      <button class="save wide" [disabled]="!anyDirty() || saving()" (click)="save()">
        {{ saving() ? 'Saving…' : 'Update Packed Status' }}
      </button>
    </div>
  }
</div>
